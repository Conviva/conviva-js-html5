/*! (C) 2021 Conviva, Inc. All rights reserved. Confidential and proprietary. */

!function(t,i){"function"==typeof define&&define.amd?define(i):("object"==typeof exports||"object"==typeof module&&module.exports)&&(module.exports=i()),void 0!==t&&(void 0===t.Conviva?void 0===t.ConvivaModule&&(t.ConvivaModuleLoading||(t.ConvivaModuleLoading=!0,t.ConvivaModule=i(),delete t.ConvivaModuleLoading)):void 0===t.Conviva.ProxyMonitor&&(t.ConvivaModuleLoading||(i=i(),t.ConvivaModuleLoading=!0,t.Conviva.ProxyMonitor=i.ProxyMonitor,t.Conviva.Impl.Html5PlayerInterface=i.Impl.Html5PlayerInterface,t.Conviva.Impl.Html5Proxy=i.Impl.Html5Proxy,delete t.ConvivaModuleLoading)))}(this,function(){var o={};return function(){"use strict";void 0!==o&&(o.Impl=o.Impl||{},o.Impl.Html5PlayerInterface=function(t,i,n){var s=this;s.t=[],s.i=0,s.n=0,s.e=!1,s.o=n,this.a=new Conviva.Impl.Html5Timer,this.r=n.buildLogger(),this.r.setModuleName("Html5PlayerInterface"),this.s=-1,this.v=-1,this.u=function(t,i,n){void 0===n&&(n=s.h),s.c.push([t,i,n]),window.addEventListener?n.addEventListener(t,i,!1):n.attachEvent("on"+t,i)},this.f=function(t,i,n){void 0===n&&(n=s.h),window.removeEventListener?n.removeEventListener(t,i,!1):n.detachEvent("on"+t,i)},this.d=function(){s.u("ended",function(){s.l("ended")}),s.u("pause",function(){s.l("pause")}),s.u("playing",function(){0===s.h.currentTime?s.e=!0:0<s.h.currentTime&&(s.e=!1)}),s.u("waiting",function(){s.l("waiting")}),s.u("timeupdate",function(){s.e&&(s.i++,s.C.getPlayerState()===Conviva.PlayerStateManager.PlayerState.PLAYING||s.h.seeking||s.l("playing"))}),s.u("error",function(){var t;s.h.error&&(t=s.h.error.code,s.N(t))}),s.u("loadedmetadata",s.p),s.u("seeking",function(){s.isSeekStarted||(s.isSeekStarted=!0,s.C.setPlayerSeekStart(-1)),s.e&&s.C.getPlayerState()!==Conviva.PlayerStateManager.PlayerState.BUFFERING&&(s.g("Adjusting Conviva player state to: BUFFERING"),s.l("waiting"))}),s.u("seeked",function(){s.isSeekStarted=!1,s.C.setPlayerSeekEnd()}),s.R()},this.getPHT=function(){return s.h?1e3*s.h.currentTime:Conviva.PlayerStateManager.DEFAULT_PHT},this.getBufferLength=function(){if(!s.h)return Conviva.PlayerStateManager.DEFAULT_BUFFER_LENGTH;var t=s.h.buffered;if(void 0!==t){for(var i=0,n=0;n<t.length;n++){var e=t.start(n),o=t.end(n);e<=s.h.currentTime&&s.h.currentTime<o&&(i+=o-s.h.currentTime)}return s.I=i,1e3*s.I}},this.getSignalStrength=function(){return Conviva.PlayerStateManager.DEFAULT_SIGNAL_STRENGTH},this.getRenderedFrameRate=function(){return Conviva.PlayerStateManager.DEFAULT_RENDERED_FRAME_RATE},this.R=function(){if(void 0!==s.h.children){var t=function(){s.g("Caught non-specific error from <source> element, reporting as ERR_UNKNOWN"),s.N(0)};s.h.A=s.h.children;for(var i=0;i<s.h.A.length;i++){var n=s.h.A[i];"SOURCE"===n.tagName&&s.u("error",t,n)}}},this.y=function(){for(var t=0;t<s.c.length;t++){var i=s.c[t];s.f(i[0],i[1],i[2])}s.c=[]},this.m=function(){s.w=s.h.readyState,0===s.h.readyState||s.h.ended?s._(Conviva.PlayerStateManager.PlayerState.STOPPED):(s.h.paused||s.h.seeking)&&s._(Conviva.PlayerStateManager.PlayerState.PAUSED),s.h.readyState>=s.h.HAVE_METADATA&&s.p()},this.l=function(t){var i=s.M(t);s.g("Received HTML5 event: "+t+". Mapped to Conviva player state: "+i),s._(i)},this._=function(t){s.C.setPlayerState(t),s.O(),s.D=!0},this.M=function(t){switch(t){case"playing":return Conviva.PlayerStateManager.PlayerState.PLAYING;case"waiting":return Conviva.PlayerStateManager.PlayerState.BUFFERING;case"ended":case"stopped":return Conviva.PlayerStateManager.PlayerState.STOPPED;case"pause":return Conviva.PlayerStateManager.PlayerState.PAUSED;default:return Conviva.PlayerStateManager.PlayerState.UNKNOWN}},this.N=function(t){var i;switch(t){case 1:i="MEDIA_ERR_ABORTED";break;case 2:i="MEDIA_ERR_NETWORK";break;case 3:i="MEDIA_ERR_DECODE";break;case 4:i="MEDIA_ERR_SRC_NOT_SUPPORTED";break;default:i="MEDIA_ERR_UNKNOWN"}s.g("Reporting error: code="+t+" message="+i);t=Conviva.Client.ErrorSeverity.FATAL;s.C.sendError(i,t)},this.p=function(){var t=s.h.duration,i=s.h.videoWidth,n=s.h.videoHeight;isNaN(t)||t===1/0||s.C.setDuration(t),!isNaN(i)&&0<=i&&s.C.setVideoResolutionWidth(i),!isNaN(n)&&0<=n&&s.C.setVideoResolutionHeight(n)},this.P=function(){this.U=0,this.V=0,this.I=0,this.T=this.a.createTimer(this.j,500,"Html5PlayerInterface._poll()")},this.j=function(){s.h&&(s.x(),s.H(),s.k())},this.x=function(){var t=s.h.videoWidth;!isNaN(t)&&0<=t&&t!==s.s&&(s.C.setVideoResolutionWidth(t),s.s=t);t=s.h.videoHeight;!isNaN(t)&&0<=t&&t!==s.v&&(s.C.setVideoResolutionHeight(t),s.v=t)},this.H=function(){s.U=s.V,s.V=s.h.currentTime;var t,i=Date.now();0<s.F&&i>s.F&&((t=s.V-s.U)<0&&(t=0),t=t/(i-s.F)*1e3,s.t.push(t)),s.F=i,s.t.length>Math.max(8,4)&&s.t.shift()},this.k=function(){var t=s.t.length;if(t>=Math.min(4,8)){for(var i=0,n=s.t.slice(),e=0;e<n.length;e++)i+=n[e];i/=t;var o=1,a=.25,r=s.h.playbackRate;!isNaN(r)&&r!==1/0&&0<r&&(0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")&&r<.5&&(r=.5),o*=r,a*=r);r=s.C.getPlayerState();if(r!==Conviva.PlayerStateManager.PlayerState.PLAYING&&4<=t&&Math.abs(i-o)<a)return s.g("Adjusting Conviva player state to: PLAYING"),void s._(Conviva.PlayerStateManager.PlayerState.PLAYING);r===Conviva.PlayerStateManager.PlayerState.PLAYING&&8<=t&&0===i?s.h.paused?r!==Conviva.PlayerStateManager.PlayerState.PAUSED&&(s.g("Adjusting Conviva player state to: PAUSED"),s._(Conviva.PlayerStateManager.PlayerState.PAUSED)):s.h.seeking||(s.g("Adjusting Conviva player state to: BUFFERING"),s._(Conviva.PlayerStateManager.PlayerState.BUFFERING)):s.e&&(s.h.paused?(r!==Conviva.PlayerStateManager.PlayerState.PAUSED&&(s.g("Adjusting Conviva player state to: PAUSED"),s._(Conviva.PlayerStateManager.PlayerState.PAUSED)),s.i=s.n):s.h.seeking||(1<s.i&&s.i===s.n&&(s.g("Adjusting Conviva player state to: BUFFERING"),s._(Conviva.PlayerStateManager.PlayerState.BUFFERING)),s.n=s.i))}},this.b=function(){this.T()},this.O=function(){s.t=[],s.U=-1,s.F=0},this.S=function(){s.n=0,s.i=0},this.g=function(t){this.r.log(t,Conviva.SystemSettings.LogLevel.DEBUG)},function(t,i){if(this.g("Html5PlayerInterface._constr()"),!t)throw new Error("Html5PlayerInterface: playerStateManager argument cannot be null.");if(!i)throw new Error("Html5PlayerInterface: videoElement argument cannot be null.");this.C=t,this.h=i,this.c=[],this.d(),this.O(),this.S(),this.P(),this.m(),this.C.setClientMeasureInterface(this),this.C.setModuleNameAndVersion("HTML5","4.0.7L"),this.o&&this.o.B&&!this.o.B.getFrameworkName()&&this.C.setPlayerType("HTML5")}.apply(this,arguments),this.cleanup=function(){this.g("Html5PlayerInterface.cleanup()"),this.b(),this.y(),this.h=null,this.C=null}}),void 0!==o&&(o.Impl=o.Impl||{},o.Impl.Html5Proxy=function(t,i,n,s){var v=this;function u(){return/MSIE|Trident|Edge\//.test(window.navigator.userAgent)}function e(){return 0<v.h.currentTime&&(v.e=!1,1)}v.t=[],v.i=0,v.n=0,v.e=!1,this.a=new s.Impl.Html5Timer,this.s=-1,this.v=-1,this.G=s.Constants.PlayerState.UNKNOWN,this.L=0,this.u=function(t,i,n){void 0===n&&(n=v.h),v.c.push([t,i,n]),window.addEventListener?n.addEventListener(t,i,!1):n.attachEvent("on"+t,i)},this.f=function(t,i,n){void 0===n&&(n=v.h),window.removeEventListener?n.removeEventListener(t,i,!1):n.detachEvent("on"+t,i)},this.d=function(){v.u("ended",function(){v.g("rx event ended: "+v.h.currentTime),v._(s.Constants.PlayerState.STOPPED)}),v.u("pause",function(){v.g("rx event pause: "+v.h.currentTime),e(),v._(s.Constants.PlayerState.PAUSED)}),v.u("playing",function(){v.g("rx event playing: "+v.h.currentTime),0===v.h.currentTime?v.e=!0:e()}),v.u("waiting",function(){v.g("rx event waiting: "+v.h.currentTime),e(),v._(s.Constants.PlayerState.BUFFERING)}),v.u("timeupdate",function(){v.g("rx event timeupdate"+v.h.currentTime),e(),v.e&&(v.i++,v.G===s.Constants.PlayerState.PLAYING||v.h.seeking||v._(s.Constants.PlayerState.PLAYING))}),v.u("error",function(){var t;v.g("rx event error: "+v.h.currentTime),v.h&&v.h.error&&(t="Error Message: "+v.h.error.message+", Error Code: "+v.h.error.code,v.K.reportPlaybackError(t,s.Constants.ErrorSeverity.FATAL))}),v.u("loadedmetadata",function(){v.g("rx event loadedmetadata: "+v.h.currentTime);var t,i=v.h.duration,n=v.h.videoWidth,e=v.h.videoHeight;isNaN(i)||i===1/0||i===Number.MAX_VALUE||((t={})[s.Constants.DURATION]=i,v.K.setContentInfo(t)),(!isNaN(n)&&0<n||!isNaN(e)&&0<e)&&v.K.reportPlaybackMetric(s.Constants.Playback.RESOLUTION,n,e,"CONVIVA")}),v.u("seeking",function(){v.g("rx event seeking: "+v.h.currentTime),v.isSeekStarted||(v.isSeekStarted=!0,v.K.reportPlaybackMetric(s.Constants.Playback.SEEK_STARTED,"CONVIVA")),e(),v.e&&v.G!==s.Constants.PlayerState.BUFFERING&&(v.g("Adjusting Conviva player state to: BUFFERING"),v._(s.Constants.PlayerState.BUFFERING))}),v.u("seeked",function(){v.g("rx event seeked: "+v.h.currentTime),e(),v.isSeekStarted=!1,v.K.reportPlaybackMetric(s.Constants.Playback.SEEK_ENDED,"CONVIVA")}),v.R()},this.getBufferLength=function(){var t=v.h.buffered;if(void 0!==t){for(var i=0,n=0;n<t.length;n++){var e=t.start(n),o=t.end(n);e<=v.h.currentTime&&v.h.currentTime<o&&(i+=o-v.h.currentTime)}return v.I=i,1e3*v.I}},this.R=function(){if(void 0!==v.h.children){var t=function(){v.g("Caught non-specific error from <source> element, reporting as ERR_UNKNOWN"),v.N(0)};v.h.A=v.h.children;for(var i=0;i<v.h.A.length;i++){var n=v.h.A[i];"SOURCE"===n.tagName&&v.u("error",t,n)}}},this.y=function(){for(var t=0;t<v.c.length;t++){var i=v.c[t];v.f(i[0],i[1],i[2])}v.c=[]},this.m=function(){v.w=v.h.readyState,0===v.h.readyState||v.h.ended?v._(s.Constants.PlayerState.STOPPED):(v.h.paused||v.h.seeking)&&v._(s.Constants.PlayerState.PAUSED)},this._=function(t){v.G=t,v.K.reportPlaybackMetric(s.Constants.Playback.PLAYER_STATE,v.G,"CONVIVA"),v.O(),v.S(),v.D=!0},this.N=function(t){var i;switch(t){case 1:i="MEDIA_ERR_ABORTED";break;case 2:i="MEDIA_ERR_NETWORK";break;case 3:i="MEDIA_ERR_DECODE";break;case 4:i="MEDIA_ERR_SRC_NOT_SUPPORTED";break;default:i="MEDIA_ERR_UNKNOWN"}v.g("Reporting error: code="+t+" message="+i);t=s.Client.ErrorSeverity.FATAL;v.K.reportPlaybackError(i,t)},this.P=function(){this.U=0,this.V=0,this.I=0,this.T=this.a.createTimer(this.j,250,"Html5Proxy._poll()")},this.j=function(){v.h?v.K.getAdType()!==s.Constants.AdType.CLIENT_SIDE?(v.K.reportPlaybackMetric(s.Constants.Playback.PLAY_HEAD_TIME,1e3*v.h.currentTime,"CONVIVA"),v.K.reportPlaybackMetric(s.Constants.Playback.BUFFER_LENGTH,v.getBufferLength(),"CONVIVA"),v.K.reportPlaybackMetric(s.Constants.Playback.RESOLUTION,v.h.videoWidth,v.h.videoHeight,"CONVIVA"),v.H(),v.k()):v.G!==s.Constants.PlayerState.UNKNOWN&&(v.G=s.Constants.PlayerState.UNKNOWN,v.O(),v.S()):(v.K.reportPlaybackMetric(s.Constants.Playback.PLAY_HEAD_TIME,s.PlayerStateManager.DEFAULT_PHT,"CONVIVA"),v.K.reportPlaybackMetric(s.Constants.Playback.BUFFER_LENGTH,s.PlayerStateManager.DEFAULT_BUFFER_LENGTH,"CONVIVA"))},this.H=function(){v.U=v.V,v.V=v.h.currentTime;var t,i=Date.now();0<v.F&&i>v.F&&(((t=v.V-v.U)<0||4<Math.abs(t))&&(t=0),t=t/(i-v.F)*1e3,v.t.push(t)),v.F=i,v.t.length>Math.max(4,4)&&v.t.shift()},this.k=function(){var t=v.t.length;if(t>=Math.min(4,4)){for(var i=0,n=v.t.slice(),e=0;e<n.length;e++)i+=n[e];i/=t;var o=1,a=.25,r=v.h.playbackRate;if(!isNaN(r)&&r!==1/0&&0<r&&(/apple/i.test(navigator.vendor)&&r<.5&&(r=.5),o*=r,a*=r),v.G!==s.Constants.PlayerState.PLAYING&&4<=t&&Math.abs(i-o)<a)return v.g("Adjusting Conviva player state to: PLAYING"),void v._(s.Constants.PlayerState.PLAYING);v.G===s.Constants.PlayerState.PLAYING&&4<=t&&0===i?v.h.paused?v.G!==s.Constants.PlayerState.PAUSED&&(v.g("Adjusting Conviva player state to: PAUSED"),v._(s.Constants.PlayerState.PAUSED)):v.h.seeking&&!u()?v.g("Adjusting Conviva player state to: BUFFERING ignored due to seeking"):(v.g("Adjusting Conviva player state to: BUFFERING"),v._(s.Constants.PlayerState.BUFFERING)):v.e&&(v.L++,v.h.paused?(v.G!==s.Constants.PlayerState.PAUSED&&(v.g("Adjusting Conviva player state to: PAUSED when currentTimeIsInvalid"),v._(s.Constants.PlayerState.PAUSED)),v.i=v.n):v.h.seeking&&!u()?v.g("Adjusting Conviva player state to: BUFFERING ignored due to seeking when currentTimeIsInvalid"):(1<v.i&&v.i===v.n&&!v.L%4&&(v.g("Adjusting Conviva player state to: BUFFERING when currentTimeIsInvalid"),v._(s.Constants.PlayerState.BUFFERING)),v.n=v.i),!v.L%4&&(v.L=0))}},this.b=function(){this.T&&this.T()},this.O=function(){v.t=[],v.U=-1,v.F=0},this.S=function(){v.n=0,v.i=0,v.L=0},this.g=function(t){this.r.log(t,s.SystemSettings.LogLevel.DEBUG)},function(t,i,n){if(!t)throw new Error("Html5Proxy: videoElement argument cannot be null.");this.h=t,this.K=n,this.r=i.buildLogger(),this.r.setModuleName("Html5Proxy"),this.g("Html5Proxy._constr()"),this.c=[],this.d(),this.O(),this.S(),this.P(),this.m(),(i={})[s.Constants.MODULE_NAME]="HTML5",i[s.Constants.MODULE_VERSION]="4.0.7",this.K.setContentInfo(i),(i={})[s.Constants.FRAMEWORK_NAME]="HTML5",this.K.setPlayerInfo(i)}.apply(this,arguments),this.cleanup=function(){this.g("Html5Proxy.cleanup()"),this.b(),this.y(),this.h=null}}),o.ProxyMonitor={W:null,release:function(){this.W&&this.W.cleanup()},initConvivaDropIn:function(t,i,n,e){if(t&&t instanceof HTMLVideoElement)return this.W=new o.Impl.Html5Proxy(t,i,n,e),this.W;throw new Error("No player proxy initialized")}}}(),o});